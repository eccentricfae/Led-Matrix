#include "../include/animations.h"


/******************** FUNCTION DECLARATIONS ********************/

static void clean_up(void);


/******************** ANIMATIONS ********************/

/**
 * To add new animation:
 *  - add the board_bytes_t array
 *  - make a new struct containing all of the info:
 *      - pointer to the array with frames to display
 *      - frame count (how many frames in animation)
 *      - time interval between frames
 *  - add the animation to the aniamtions array
 *  - change the ANIM_COUNT define
 */
#define ANIM_COUNT 3

// "Hard-coding" animations like that is such a pain in the ass lmao 

board_bytes_t const all_on_frames[] = {
    { { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF}, { 0xFF, 0xFF} }
};

animation_t const all_on = {
    .ptr_to_frames = all_on_frames,
    .frames_count = 1,
    .time_between_frames_ms = -1
};

board_bytes_t const checkerboard_frames[] = {
    { { 0xAA, 0xAA }, { 0x55, 0x55 },  { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA }, { 0x55, 0x55 } },
    { { 0x55, 0x55 },  { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA }, { 0x55, 0x55 }, { 0xAA, 0xAA } }
};

animation_t const checkerboard = {
    .ptr_to_frames = checkerboard_frames,
    .frames_count = 2,
    .time_between_frames_ms = 1000
};

board_bytes_t const diamond_frames[] = {
    { { 0x01, 0x80 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x3F, 0xFC }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x3F, 0xFC }, { 0x1F, 0xF8 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x3F, 0xFC }, { 0x1F, 0xF8 }, { 0x0F, 0xF0 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x3F, 0xFC }, { 0x1F, 0xF8 }, { 0x0F, 0xF0 }, { 0x07, 0xE0 }, { 0x00, 0x00 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x3F, 0xFC }, { 0x1F, 0xF8 }, { 0x0F, 0xF0 }, { 0x07, 0xE0 }, { 0x03, 0xC0 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x3F, 0xFC }, { 0x1F, 0xF8 }, { 0x0F, 0xF0 }, { 0x07, 0xE0 }, { 0x03, 0xC0 }, { 0x01, 0x80 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x3F, 0xFC }, { 0x1F, 0xF8 }, { 0x0F, 0xF0 }, { 0x07, 0xE0 }, { 0x03, 0xC0 }, { 0x01, 0x80 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x3F, 0xFC }, { 0x1F, 0xF8 }, { 0x0F, 0xF0 }, { 0x07, 0xE0 }, { 0x03, 0xC0 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x3F, 0xFC }, { 0x1F, 0xF8 }, { 0x0F, 0xF0 }, { 0x07, 0xE0 }, { 0x00, 0x00 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x3F, 0xFC }, { 0x1F, 0xF8 }, { 0x0F, 0xF0 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x3F, 0xFC }, { 0x1F, 0xF8 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x3F, 0xFC }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x7F, 0xFE }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0xFF, 0xFF }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } }, 
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0xFF, 0xFF }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x7F, 0xFE }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x3F, 0xFC }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x1F, 0xF8 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x0F, 0xF0 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x07, 0xE0 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x03, 0xC0}, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } },
    { { 0x01, 0x80 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 }, { 0x00, 0x00 } }
};

animation_t const diamond = {
    .ptr_to_frames = diamond_frames,
    .frames_count = 32,
    .time_between_frames_ms = 300
};

animation_t const * const animations[] = { &all_on, &checkerboard, &diamond};

// Global variables above are needed I reckon, but the global variables below are
// just here cuz IDK how else would I implement everything - too many variables
// are needed across too many callbacks and function, thus: this many global variables

uint8_t curr_anim_nr;

board_bytes_t const * curr_frame = NULL;

repeating_timer_t frame_rt;

bool ext = false;


/******************** CALLBACKS ********************/

/**
 * @brief Callback function that chnages data in order
 * for the module to print out the next frame of the 
 * current animation
 * 
 * @param rt Pointer to the repeating_timer_t struct that 
 * uses this function as a callback
 * @return true Keep repeating
 * @return false Stop repeating
 */
static bool frame_rt_callback(repeating_timer_t * rt)
{
    static uint8_t curr_frame_nr = 0;

    if (++curr_frame_nr >= animations[curr_anim_nr]->frames_count) { curr_frame_nr = 0; }
    curr_frame = animations[curr_anim_nr]->ptr_to_frames + curr_frame_nr;

    return true;
}

/**
 * @brief IRQ handler (callback) function that either exits the module,
 * or changes the animations currently being displayed to the next in queue
 */
static void input_callback(uint gpio, uint32_t events)
{
    if (gpio == LEFT_INPUT_GPIO) { ext = true; }
    
    if (++curr_anim_nr >= ANIM_COUNT) { curr_anim_nr = 0; }
    curr_frame = &animations[curr_anim_nr]->ptr_to_frames[0];
    
    cancel_repeating_timer(&frame_rt);
    add_repeating_timer_ms(animations[curr_anim_nr]->time_between_frames_ms, frame_rt_callback, NULL, &frame_rt);
}


/******************** INIT FUNCTIONS ********************/

void init_animations(void)
{
    gpio_set_irq_enabled_with_callback(UP_INPUT_GPIO,    GPIO_IRQ_EDGE_RISE, true, input_callback);
    gpio_set_irq_enabled_with_callback(RIGHT_INPUT_GPIO, GPIO_IRQ_EDGE_RISE, true, input_callback);
    gpio_set_irq_enabled_with_callback(DOWN_INPUT_GPIO,  GPIO_IRQ_EDGE_RISE, true, input_callback);
    gpio_set_irq_enabled_with_callback(LEFT_INPUT_GPIO,  GPIO_IRQ_EDGE_RISE, true, input_callback);

    gpio_pull_down(UP_INPUT_GPIO);
    gpio_pull_down(RIGHT_INPUT_GPIO);
    gpio_pull_down(DOWN_INPUT_GPIO);
    gpio_pull_down(LEFT_INPUT_GPIO);

    curr_anim_nr = 0;
    curr_frame = &animations[curr_anim_nr]->ptr_to_frames[0];
    ext = false;
}


/******************** MAIN LOGIC ********************/

void run_animations(void)
{
    add_repeating_timer_ms(animations[curr_anim_nr]->time_between_frames_ms, frame_rt_callback, NULL, &frame_rt);

    while (true) {
        if (ext) { break; }
        matrix_print_frame(curr_frame);
    }

    clean_up();
}

static void clean_up(void)
{
    cancel_repeating_timer(&frame_rt);

    gpio_set_irq_enabled(UP_INPUT_GPIO,    GPIO_IRQ_EDGE_RISE, false);
    gpio_set_irq_enabled(RIGHT_INPUT_GPIO, GPIO_IRQ_EDGE_RISE, false);
    gpio_set_irq_enabled(DOWN_INPUT_GPIO,  GPIO_IRQ_EDGE_RISE, false);
    gpio_set_irq_enabled(LEFT_INPUT_GPIO,  GPIO_IRQ_EDGE_RISE, false);

    gpio_disable_pulls(UP_INPUT_GPIO);
    gpio_disable_pulls(RIGHT_INPUT_GPIO);
    gpio_disable_pulls(DOWN_INPUT_GPIO);
    gpio_disable_pulls(LEFT_INPUT_GPIO);
}